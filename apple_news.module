<?php

/**
 * @file
 * Main module file.
 */

define('APPLE_NEWS_API_VERSION', 1);
define('CURL_SUPPORTED_VERSION', '3.5.5');
define('APPLE_NEWS_SUPPORTED_VERSION', '0.1.9');

// Load Batch API helper functions.
module_load_include('inc', 'apple_news', 'apple_news.batch');

/**
 * Implements hook_init().
 */
function apple_news_init() {
  // Detect and load 'php-curl-class' PHP library.
  if (($library = libraries_detect('php-curl-class')) && 
      !empty($library['installed']) &&
      $library['version'] == CURL_SUPPORTED_VERSION)
  {
    libraries_load('php-curl-class');
  }
  else {
    $error_message = !empty($library['error message']) ? $library['error message'] : '';
    $msg = t('Please download <a href="!link" target="_blank">@name (version @v)</a> library to <em>sites/all/libraries/php-curl-class</em> directory.',
      [
        '!link' => $library['download url'],
        '@name' => $library['name'],
        '@v'    => CURL_SUPPORTED_VERSION,
      ]
    );
    drupal_set_message($error_message . ' ' . $msg, 'error');
  }
  // Detect and load 'AppleNews' PHP library.
  if (($library = libraries_detect('AppleNews')) &&
      !empty($library['installed']) &&
      $library['version'] == APPLE_NEWS_SUPPORTED_VERSION)
  {
    libraries_load('AppleNews');
  }
  else {
    $error_message = !empty($library['error message']) ? $library['error message'] : '';
    $msg = t('Please download <a href="!link" target="_blank">@name (version @v)</a> library to <em>sites/all/libraries/AppleNews</em> directory.',
      [
        '!link' => $library['download url'],
        '@name' => $library['name'],
        '@v'    => APPLE_NEWS_SUPPORTED_VERSION,
      ]
    );
    drupal_set_message($error_message . ' ' . $msg, 'error');
  }
}

/**
 * Implements hook_libraries_info().
 */
function apple_news_libraries_info() {

  $libraries['AppleNews'] = [
    'name' => 'Apple News',
    'vendor url' => 'https://github.com/chapter-three/AppleNews',
    'download url' => 'https://github.com/chapter-three/AppleNews/archive/0.1.9.zip',
    'files' => [
      'php' => [
        'autoload.php',
      ],
    ],
    'version arguments' => [
      'file' => 'src/PushAPI.php',
      'pattern' => "/'([^']+)'/",
      'lines' => 25,
      'cols' => 200,
    ],
  ];

  $libraries['php-curl-class'] = [
    'name' => 'PHP Curl Class: HTTP requests made easy',
    'vendor url' => 'https://github.com/php-curl-class/php-curl-class',
    'download url' => 'https://github.com/php-curl-class/php-curl-class/archive/3.5.5.zip',
    'files' => [
      'php' => [
        'src/Curl/Curl.php',
        'src/Curl/MultiCurl.php',
      ],
    ],
    'version arguments' => [
      'file' => 'src/Curl/Curl.php',
      'pattern' => "/'([^']+)'/",
      'lines' => 25,
      'cols' => 10,
    ],
  ];

  return $libraries;
}

/**
 * Implements hook_hook_info().
 */
function apple_news_hook_info() {

  // Form hooks see {module_name}.form.inc
  $form = ['group' => 'form'];
  $hooks['form_alter'] = $form;

  // Entity hooks see {module_name}.entity.inc
  $entity = ['group' => 'entity'];
  $hooks['entity_load'] = $entity;
  $hooks['entity_insert'] = $entity;
  $hooks['entity_update'] = $entity;
  $hooks['entity_delete'] = $entity;
  $hooks['entity_presave'] = $entity;

  // Views hooks see {module_name}.views.inc
  $views = ['group' => 'views'];
  $hooks['views_api'] = $views;
  $hooks['views_data'] = $views;
  $hooks['views_default_views'] = $views;

  // Apple News hooks see {module_name}.apple_news.inc
  $apple_news = ['group' => 'apple_news'];
  $hooks['apple_news_insert'] = $apple_news;
  $hooks['apple_news_update'] = $apple_news;
  $hooks['apple_news_delete'] = $apple_news;
  $hooks['apple_news_api_alter'] = $apple_news;
  $hooks['apple_news_api'] = $apple_news;

  return $hooks;

}

/**
 * Implements hook_help().
 */
function apple_news_help($path, $arg) {
  switch ($path) {
    case 'admin/help#apple_news':
      return '<p>' . t('Push content to <a href="https://www.apple.com/news/">Apple News</a>.') . '</p>';
  }
}

/**
 * Implements hook_permission().
 */
function apple_news_permission() {
  return [
    'administer apple news' => [
      'title' => t('Administer Apple News'),
      'description' => t('Perform administration tasks for Apple News'),
    ],
  ];
}

/**
 * Implements hook_menu().
 */
function apple_news_menu() {

  $items['admin/config/content/apple-news'] = [
    'title' => 'Apple News',
    'description' => t('Configure content export to Apple News.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => ['apple_news_settings_exports_form'],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
  ];

  $items['admin/config/content/apple-news/exports'] = [
    'title' => 'Exports',
    'description' => t('List and edit Apple News export configurations.'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
  ];

  $items['admin/config/content/apple-news/exports/%apple_news_export'] = [
    'title' => 'Edit Export',
    'description' => t('Apple News Export configuration.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => ['apple_news_export_edit_form', 5],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
  ];

  $items['admin/config/content/apple-news/exports/%apple_news_export/%/%'] = [
    'title' => 'Edit Export Destination',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['apple_news_export_destination_edit_form', 5, 6, 7],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
  ];

  $items['admin/config/content/apple-news/exports/%apple_news_export/%/%/delete'] = [
    'title' => 'Delete Export Destination',
    'page callback' => 'apple_news_export_destination_delete',
    'page arguments' => [5, 6, 7],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
  ];

  $items['admin/config/content/apple-news/settings'] = [
    'title' => 'Settings',
    'description' => t('Apple News Push API configuration.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => ['apple_news_settings_api_credentials_form'],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  ];

  $items['admin/config/content/apple-news/settings/default'] = [
    'title' => 'Credentials',
    'description' => t('Apple News Push API credentials.'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 1,
  ];

  $items['admin/config/content/apple-news/settings/delete'] = [
    'title' => 'Delete configuration',
    'description' => t('Delete Apple News configuration.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => ['apple_news_settings_delete_configuration_form'],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
    'weight' => 1,
  ];

  $items['admin/config/content/apple-news/settings/channels'] = [
    'title' => 'Feeds',
    'description' => t('Apple News Push API channels.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => ['apple_news_settings_channels_form'],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  ];

  // [channel-id]
  $items['admin/config/content/apple-news/settings/channels/%/delete'] = [
    'title' => 'Delete channel',
    'description' => t('Apple News Push API delete channel.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => ['apple_news_settings_delete_channel_form', 6],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
    'weight' => 1,
  ];

  // [channel-id]
  $items['admin/config/content/apple-news/settings/channels/%/sections'] = [
    'title' => 'View Feed Sections',
    'description' => t('View Apple News channel sections.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => ['apple_news_settings_channel_sections_form', 6],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
    'weight' => 1,
  ];

  // Delete an article from Apple News channel
  // [entity-type]/[entity-id]/[article-id]/[channel-id]
  $items['admin/config/content/apple-news/%/%/%/%/delete'] = [
    'title' => 'Delete Apple News article',
    'description' => t('Apple News Push API delete channel.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => ['apple_news_settings_delete_article_form', 4, 5, 6, 7],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
    'weight' => 1,
  ];

  // [article-id]
  $items['admin/config/content/apple-news/%/download'] = [
    'title' => 'Download article.json file',
    'description' => t('Download previewable Apple News formatted document.'),
    'page callback' => 'apple_news_download_article_json',
    'page arguments' => [4],
    'access arguments' => ['administer apple news'],
    'file' => 'apple_news.admin.inc',
    'type' => MENU_CALLBACK,
    'weight' => 1,
  ];

  return $items;
}

/**
 * Implements OBJECT_load().
 *
 * @see menu_get_item()
 */
function apple_news_export_load($id) {
  module_load_include('inc', 'apple_news');
  list($module, $machine_name) = apple_news_export_id_extract($id);
  return apple_news_get_export($module, $machine_name);
}

/**
 * Implements hook_cron().
 */
function apple_news_cron() {
  module_load_include('inc', 'apple_news');
}

/**
 * Implements hook_theme().
 */
function apple_news_theme($existing, $type, $theme, $path) {
  return [
    'apple_news_export_edit_form' => [
      'render element' => 'form',
      'file' => 'apple_news.admin.inc',
    ],
  ];
}

/**
 * Implements hook_apple_news_api().
 */
function apple_news_apple_news_api() {
  return [
    'api' => APPLE_NEWS_API_VERSION,
    'exports' => [
      'node' => [
        'class' => 'ApplenewsExportNode',
        'name' => t('Nodes'),
        'description' => t('Configurable node export.'),
      ],
    ],
    'sources' => [
      'node' => [
        'class' => 'ApplenewsSourceNode',
        'name' => 'Node',
      ],
      'user' => [
        'class' => 'ApplenewsSourceUser',
        'name' => 'User',
      ],
      'field' => [
        'class' => 'ApplenewsSourceField',
        'name' => 'Field Value',
      ],
    ],
    'destinations' => [
      'body' => [
        'class' => 'ApplenewsDestinationBody',
        'name' => 'Body',
      ],
      'bodyphoto' => [
        'class' => 'ApplenewsDestinationBodyPhoto',
        'name' => 'Body and Photos',
      ],
    ],
  ];
}
