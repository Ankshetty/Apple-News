<?php

/**
 * @file
 * Main module file.
 */

/**
 * Implements hook_help().
 */
function apple_news_help($path, $arg) {
  switch ($path) {

    case 'admin/help#apple_news':
      return '<p>' . t('Push content to <a href="https://www.apple.com/news/">Apple News</a>.') . '</p>';

  }
}

/**
 * Implements hook_menu().
 */
function apple_news_menu() {
  $items = array();

  $items['admin/config/content/apple_news'] = array(
    'title' => 'Apple News',
    'description' => t('Configure content export to Apple News.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('apple_news_settings_form'),
    'access arguments' => array('administer apple_news'),
    'file' => 'apple_news.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function apple_news_permission() {
  return array(
    'administer apple_news' => array(
      'title' => t('Administer Apple News'),
      'description' => t('Perform administration tasks for Apple News'),
    ),
    'push content to apple news' => array(
      'title' => t('Push content to Apple News'),
      'description' => '',
    ),
  );
}

/**
 * Converts drupal language code to appropriate Apples News value.
 */
function apple_news_language_code($language_code) {
  // @todo
  return $language_code;
}

/**
 * Gets channel data.
 */
function apple_news_get_channel() {
  $api_channel = variable_get('apple_news_variable_api_channel', FALSE);
  $get = _apple_news_get_api_get();
  $response = $get->Get('/channels/{channel_id}',
    ['channel_id' => $api_channel]);
  if (!$response) {
    watchdog('apple_news', $get->curl->curl_error_message, array(),
      WATCHDOG_ERROR);
    return FALSE;
  }
  return $response;
}

/**
 * Gets a news api object.
 */
function _apple_news_get_api_get() {
  $api_key = variable_get('apple_news_variable_api_key', FALSE);
  $api_secret = variable_get('apple_news_variable_api_secret', FALSE);
  $api_endpoint = variable_get('apple_news_variable_api_endpoint', FALSE);
  $get = new ChapterThree\AppleNews\PushAPI\Get($api_key, $api_secret,
    $api_endpoint);

  // Allow configuring curl for debugging.
  $curlopts = variable_get('apple_news_variable_api_curlopt', array());
  foreach ($curlopts as $key => $val) {
    $get->curl->setOpt($key, $val);
  }

  return $get;
}

/**
 * Gets a news api object.
 */
function _apple_news_get_api_post() {
  $api_key = variable_get('apple_news_variable_api_key', FALSE);
  $api_secret = variable_get('apple_news_variable_api_secret', FALSE);
  $api_endpoint = variable_get('apple_news_variable_api_endpoint', FALSE);
  $post = new ChapterThree\AppleNews\PushAPI\Post($api_key, $api_secret,
    $api_endpoint);

  // Allow configuring curl for debugging.
  $curlopts = variable_get('apple_news_variable_api_curlopt', array());
  foreach ($curlopts as $key => $val) {
    $post->curl->setOpt($key, $val);
  }

  return $post;
}

